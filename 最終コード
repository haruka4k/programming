import sympy as sp

# å¤‰æ•°ã®å®šç¾©
n = sp.Symbol('n')

# å„æ“ä½œãƒ«ãƒ¼ãƒ«ã®é©ç”¨
def apply_rule(expr, rule):
    if rule == 1:
        return (2 * expr - 1) / 3
    elif rule == 2:
        return 4 * expr / 3
    elif rule == 3:
        return 4 * expr + 2
    else:
        raise ValueError("ä¸æ­£ãªãƒ«ãƒ¼ãƒ«")

# å¢—åŠ é‡é–¢æ•° f(n) ã®æ§‹ç¯‰
def build_fn(rule_sequence):
    expr = n
    for rule in rule_sequence:
        expr = apply_rule(expr, rule)
    return sp.simplify(expr)

# å¢—åŠ ç‡é–¢æ•° Î³(n) = (6f(n)+4)/(6n+4)
def compute_growth_rate_fn(f_n):
    return sp.simplify((6 * f_n + 4) / (6 * n + 4))

# çµ‚ç«¯ãƒ«ãƒ¼ãƒ«ã«å¿œã˜ãŸæ§‹æ–‡æ¡ä»¶ (n â‰¡ r mod m) ã‚’å°å‡º
def extract_congruence_from_fn(f_n, terminal_rule):
    if terminal_rule == 1:
        expr = (f_n - 1) / 2
    elif terminal_rule == 2:
        expr = f_n / 4
    elif terminal_rule == 3:
        expr = (f_n - 6) / 12
    else:
        raise ValueError("æœªçŸ¥ã®çµ‚ç«¯ãƒ«ãƒ¼ãƒ«")

    numer, denom = expr.as_numer_denom()
    numer = sp.simplify(numer)
    denom = sp.simplify(denom)
    An = sp.expand(numer)
    A = An.coeff(n)
    B = sp.simplify(An - A * n)
    A_inv = sp.mod_inverse(A, denom)
    r = int((-B * A_inv) % denom)
    return r, denom

# å…¨ä½“è§£æã‚’ä¸€æ‹¬ã§è¡Œã†é–¢æ•°
def full_analysis(rule_sequence):
    f_n = build_fn(rule_sequence)
    growth_rate_fn = compute_growth_rate_fn(f_n)
    terminal_rule = rule_sequence[-1]
    r, m = extract_congruence_from_fn(f_n, terminal_rule)
    f_r = f_n.subs(n, r)

    return {
        "æ“ä½œç³»åˆ—": rule_sequence,
        "å¢—åŠ é‡é–¢æ•° f(n)": f_n,
        "å¢—åŠ ç‡é–¢æ•° Î³(n)": growth_rate_fn,
        "æ§‹æ–‡æ¡ä»¶": f"n â‰¡ {r} mod {m}",
        "æœ€å°ã®é©ç”¨å¯èƒ½ãª n": r,
        "6n+4": 6 * r + 4,
        "6f(n)+4": 6 * f_r + 4,
        "å¢—åŠ é‡": sp.simplify(6 * f_r + 4 - (6 * r + 4)),
        "å¢—åŠ ç‡ï¼ˆæ•°å€¤ï¼‰": sp.simplify((6 * f_r + 4) / (6 * r + 4))
    }

# ğŸ”· å¤–éƒ¨å…¥åŠ›ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§æ“ä½œç³»åˆ—ã‚’å…¥åŠ›ï¼‰
user_input = input("æ“ä½œç³»åˆ—ã‚’ã‚«ãƒ³ãƒã§åŒºåˆ‡ã£ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 1,2,2ï¼‰: ")
rule_sequence = [int(x.strip()) for x in user_input.split(',')]

# ğŸ”· è§£æã¨å‡ºåŠ›
result = full_analysis(rule_sequence)

# ğŸ”· æ•´å½¢ã—ã¦å‡ºåŠ›
for key, value in result.items():
    print(f"\nãƒ»{key}:\n{value}")
